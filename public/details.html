<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Details</title>
    <style>
        body { 
            font-family: monospace; 
            background-color: #0d1117; 
            color: #c9d1d9; 
            padding: 2rem;
        }
        h1, h2 { 
            color: #58a6ff; 
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.5rem;
        }
        pre { 
            background-color: #161b22; 
            padding: 1rem; 
            border-radius: 6px; 
            white-space: pre-wrap;
            word-break: break-all;
        }
        a {
            color: #58a6ff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="/">&lt; Back to Dashboard</a>
    <h1 id="domain-header">Loading...</h1>

    <div id="details-content">
        <section>
            <h2>Top Referrers</h2>
            <pre id="referrers-data">Loading...</pre>
        </section>
        <section>
            <h2>Top Browsers</h2>
            <pre id="browsers-data">Loading...</pre>
        </section>
        <section>
            <h2>Top Devices</h2>
            <pre id="devices-data">Loading...</pre>
        </section>
        <section>
            <h2>Recent Visitors (IP)</h2>
            <pre id="ips-data">Loading...</pre>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const domain = params.get('domain');

            if (!domain) {
                document.getElementById('domain-header').textContent = "Error: No domain specified.";
                return;
            }

            document.getElementById('domain-header').textContent = `Details for: ${domain}`;

            try {
                const response = await fetch(`/api/bpx?view=domain_details&domain=${domain}`);
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                const data = await response.json();

                const formatData = (items, key1, key2) => {
                    if (!items || items.length === 0) return 'No data available.';
                    // Find the longest key to align the output, handling null/undefined values
                    const maxLength = Math.max(...items.map(item => String(item[key1] || 'N/A').length));
                    // Format each line, handling null/undefined values
                    return items.map(item => {
                        const value1 = String(item[key1] || 'N/A').padEnd(maxLength, ' ');
                        const value2 = item[key2];
                        return `${value1} : ${value2}`;
                    }).join('\n');
                };
                
                document.getElementById('referrers-data').textContent = formatData(data.referrers, 'referrer', 'count');
                document.getElementById('browsers-data').textContent = formatData(data.browsers, 'browser', 'count');
                document.getElementById('devices-data').textContent = formatData(data.devices, 'device_type', 'count');
                
                // Special formatting for IPs, handling null/undefined values
                const ipsText = data.ips && data.ips.length > 0
                    ? data.ips.map(ip => {
                        const ipAddress = (ip.ip_address || 'N/A').padEnd(20, ' ');
                        const lastVisit = ip.last_visit ? new Date(ip.last_visit).toLocaleString() : 'N/A';
                        return `${ipAddress} : ${ip.views} views (last visit: ${lastVisit})`;
                    }).join('\n')
                    : 'No data available.';
                document.getElementById('ips-data').textContent = ipsText;

            } catch (error) {
                console.error("Failed to load domain details:", error);
                document.getElementById('details-content').innerHTML = `<p style="color: #f85149;">Failed to load domain details: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>

