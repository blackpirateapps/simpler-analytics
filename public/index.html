<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fira Code', monospace; line-height: 1.6; }
        .time-range-btn { background: transparent; color: #333; border: 1px solid #333; padding: 4px 12px; margin: 0 5px 0 0; cursor: pointer; font-size: 14px; border-radius: 4px; transition: all 0.2s ease-in-out; }
        .time-range-btn.active { background: #000; color: #fff; }
        .data-list-row { border-bottom: 1px solid #ddd; padding: 10px 5px; display: flex; justify-content: space-between; align-items: center; }
        .data-list-row:hover { background-color: #f9f9f9; cursor: pointer; }
        .section-header { font-size: 18px; margin-bottom: 15px; font-weight: 600; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(90deg); }
        .arrow { transition: transform 0.2s ease-in-out; }
        #password-modal { display: none; }
    </style>
</head>
<body class="bg-white text-gray-800 antialiased">

    <div id="main-container" class="max-w-4xl mx-auto p-5 md:p-8">
        <h1 class="text-3xl font-bold mb-6 text-center md:text-left">Web Analytics Overview</h1>
        
        <!-- ... (Settings Section is unchanged) ... -->
        <details class="mb-8 bg-gray-50 rounded-lg border border-gray-200">
            <summary class="font-semibold cursor-pointer text-lg p-4 flex justify-between items-center">
                <span>Settings & Tracking Script</span>
                <svg class="w-5 h-5 arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </summary>
            <div class="p-4 mt-2 grid grid-cols-1 md:grid-cols-2 gap-8 pt-4 border-t border-gray-200">
                <div>
                    <h3 class="font-semibold mb-3 text-gray-700">Manage Tracked Domains</h3>
                    <form id="add-domain-form" class="flex items-center space-x-2 mb-4">
                        <input type="text" id="domain-input" placeholder="example.com" class="border border-gray-300 rounded px-2 py-1 flex-grow w-full" required>
                        <button type="submit" class="bg-black text-white px-4 py-1 rounded hover:bg-gray-800 transition-colors">ADD</button>
                    </form>
                    <div id="form-message" class="text-sm min-h-[1.25rem] font-mono"></div>
                    <h4 class="text-gray-600 mt-4 mb-2 text-sm font-semibold">Tracked Domains:</h4>
                    <ul id="tracked-domains-list" class="text-gray-800 space-y-1 text-sm"><li>Loading...</li></ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-3 text-gray-700">Get Tracking Script</h3>
                    <p class="text-gray-500 text-sm mb-4">Add this script inside the &lt;body&gt; tag of any site you want to track.</p>
                    <div class="relative">
                        <pre><code id="tracking-script-block" class="bg-gray-800 text-white text-xs p-4 rounded block whitespace-pre-wrap"></code></pre>
                        <button id="copy-script-button" class="absolute top-2 right-2 bg-gray-600 text-white text-xs font-semibold px-2 py-1 rounded hover:bg-gray-500 transition">COPY</button>
                    </div>
                </div>
            </div>
        </details>

        <!-- ... (Header is unchanged) ... -->
        <header id="dashboard-header" class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex flex-wrap items-center gap-y-4 gap-x-8">
                <div id="time-range-selector">
                    <span class="mr-3 text-gray-600">Period:</span>
                    <button data-period="1d" class="time-range-btn">Last 24h</button>
                    <button data-period="7d" class="time-range-btn active">Last 7 days</button>
                    <button data-period="30d" class="time-range-btn">Last 30 days</button>
                    <button data-period="90d" class="time-range-btn">Last 90 days</button>
                </div>
                 <div id="domain-filter-container">
                    <span class="mr-3 text-gray-600">Domain:</span>
                    <select id="domain-filter" class="border border-gray-300 rounded px-2 py-1.5 text-sm">
                        <option value="all">All Domains</option>
                    </select>
                </div>
            </div>
        </header>

        <main id="analytics-content">
            <p class="text-gray-500">Fetching analytics data...</p>
        </main>

        <footer class="text-center text-xs text-gray-500 mt-12 pt-5 border-t border-gray-200">
            Last updated: <span id="last-updated"></span>
        </footer>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Admin Access</h3>
            <p class="text-sm text-gray-600 mb-4">Enter the password to view IP addresses.</p>
            <form id="password-form">
                <input type="password" id="password-input" class="border border-gray-300 rounded w-full px-3 py-2 mb-4" placeholder="Password" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-password" class="bg-gray-200 px-4 py-2 rounded text-sm font-semibold">Cancel</button>
                    <button type="submit" class="bg-black text-white px-4 py-2 rounded text-sm font-semibold">Submit</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- DOM Element Refs ---
        const analyticsContent = document.getElementById('analytics-content');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const cancelPasswordBtn = document.getElementById('cancel-password');
        // ... other DOM refs are the same
        const lastUpdatedSpan = document.getElementById('last-updated');
        const addDomainForm = document.getElementById('add-domain-form');
        const domainInput = document.getElementById('domain-input');
        const formMessage = document.getElementById('form-message');
        const trackedDomainsList = document.getElementById('tracked-domains-list');
        const trackingScriptBlock = document.getElementById('tracking-script-block');
        const copyScriptButton = document.getElementById('copy-script-button');
        const domainFilter = document.getElementById('domain-filter');
        const timeRangeSelector = document.getElementById('time-range-selector');
        
        let apiDataCache = null;
        let fullTrackingScript = '';
        let currentUrlForAdmin = null;

        // --- RENDER FUNCTIONS ---
        // ... (renderDashboardView is unchanged)
        function renderDashboardView(data) {
            const selectedDomain = domainFilter.value;
            const summary = data.summary || {};
            const overview = data.overview || {};
            const pagesToRender = selectedDomain === 'all' ? Object.values(summary).flat() : (summary[selectedDomain] || []);
            const domainViews = pagesToRender.reduce((sum, page) => sum + page.views, 0);
            const domainUniques = pagesToRender.reduce((sum, page) => sum + (page.unique_views || 0), 0);
            const topPages = pagesToRender.sort((a, b) => b.views - a.views).slice(0, 10);
            const overviewMetrics = [
                { label: 'Page Views', value: (selectedDomain === 'all' ? overview.pageViews : domainViews).toLocaleString() },
                { label: 'Unique Visitors', value: (selectedDomain === 'all' ? overview.uniqueVisitors : domainUniques).toLocaleString() },
                { label: 'Bounce Rate', value: `${overview.bounceRate}%` },
                { label: 'Avg Session', value: formatSeconds(overview.avgSessionSeconds) },
            ];
            let overviewHtml = overviewMetrics.map(metric => `<div><div class="text-2xl font-bold">${metric.value}</div><div class="text-sm text-gray-500">${metric.label}</div></div>`).join('');
            let topPagesHtml = topPages.length > 0 ? topPages.map(page => {
                const percentage = domainViews > 0 ? ((page.views / domainViews) * 100).toFixed(1) : 0;
                const path = new URL(page.url).pathname;
                return `<div class="data-list-row" onclick="showLogDetails('${encodeURIComponent(page.url)}')"><span>${path}</span><span class="flex gap-4 items-center"><span>${page.views.toLocaleString()}</span><span class="text-gray-500 w-16 text-right">${percentage}%</span></span></div>`;
            }).join('') : '<p class="text-gray-500 p-4 text-center">No page view data for this domain yet.</p>';
            analyticsContent.innerHTML = `<div class="mb-10"><h2 class="section-header">Overview</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-5">${overviewHtml}</div></div><div><h2 class="section-header">Top Pages</h2><div class="border-t border-gray-200">${topPagesHtml}</div></div>`;
        }

        function renderLogDetailsView(url, logs, isAdmin = false) {
            const decodedUrl = decodeURIComponent(url);
            const path = new URL(decodedUrl).pathname;
            
            const ipHeader = isAdmin ? '<th class="p-2 font-semibold text-gray-500">IP ADDRESS</th>' : '';
            const ipCells = (log) => isAdmin ? `<td class="p-2">${log.ip_address}</td>` : '';

            let logsHtml = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('en-GB', { timeZone: 'UTC' });
                const referrer = log.referrer ? new URL(log.referrer).hostname : 'direct';
                return `<tr class="border-b border-gray-200 text-xs">
                    <td class="p-2 text-gray-500">${timestamp}</td>
                    <td class="p-2">${log.country}</td>
                    ${ipCells(log)}
                    <td class="p-2">${log.browser}</td>
                    <td class="p-2">${log.device_type}</td>
                    <td class="p-2" title="${log.referrer || ''}">${referrer}</td>
                </tr>`;
            }).join('');

            const adminButton = `<button onclick="requestAdminView('${url}')" class="text-xs font-semibold text-blue-600 hover:underline">Show IP</button>`;

            analyticsContent.innerHTML = `<div class="mb-10">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="section-header inline">Recent Activity: ${path}</h2>
                        <span class="ml-4">${adminButton}</span>
                    </div>
                    <button onclick="showSummaryView()" class="text-sm font-semibold hover:text-blue-600">&lt; BACK TO SUMMARY</button>
                </div>
                <div class="overflow-x-auto border-t border-gray-200">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-300 text-xs">
                                <th class="p-2 font-semibold text-gray-500">TIMESTAMP (UTC)</th>
                                <th class="p-2 font-semibold text-gray-500">COUNTRY</th>
                                ${ipHeader}
                                <th class="p-2 font-semibold text-gray-500">BROWSER</th>
                                <th class="p-2 font-semibold text-gray-500">DEVICE</th>
                                <th class="p-2 font-semibold text-gray-500">REFERRER</th>
                            </tr>
                        </thead>
                        <tbody>${logsHtml}</tbody>
                    </table>
                </div>
            </div>`;
        }
        
        // --- DATA FETCHING & STATE MANAGEMENT ---
        // ... (fetchDataAndRender and showSummaryView are unchanged)
        async function fetchDataAndRender(period) {
            analyticsContent.innerHTML = '<p class="text-gray-500">Fetching analytics data...</p>';
            try {
                const response = await fetch(`/api/bpx?period=${period}`);
                if (!response.ok) throw new Error(`Failed to fetch data (${response.status})`);
                const data = await response.json();
                apiDataCache = data;
                renderDashboardView(apiDataCache);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        function showSummaryView() { if (apiDataCache) renderDashboardView(apiDataCache); }

        async function showLogDetails(url, adminKey = null) {
            analyticsContent.innerHTML = `<p class="text-gray-500">Fetching logs...</p>`;
            try {
                const apiUrl = adminKey ? `/api/bpx?view=details&url=${url}&admin_key=${adminKey}` : `/api/bpx?view=details&url=${url}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Failed to fetch logs (${response.status})`);
                const logs = await response.json();
                renderLogDetailsView(url, logs, !!adminKey);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                alert('Failed to fetch admin data. Is the password correct?');
            }
        }
        
        // --- ADMIN & PASSWORD LOGIC ---
        function requestAdminView(url) {
            currentUrlForAdmin = url;
            passwordModal.style.display = 'flex';
            passwordInput.focus();
        }

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            if (password && currentUrlForAdmin) {
                showLogDetails(currentUrlForAdmin, password);
            }
            passwordModal.style.display = 'none';
            passwordInput.value = '';
        });

        cancelPasswordBtn.addEventListener('click', () => {
            passwordModal.style.display = 'none';
            passwordInput.value = '';
        });


        // --- DOMAIN & SCRIPT MANAGEMENT ---
        // ... (All functions in this section are unchanged)
        function formatSeconds(seconds) { if (seconds < 60) return `${seconds}s`; const minutes = Math.floor(seconds / 60); const remainingSeconds = seconds % 60; return `${minutes}m ${remainingSeconds}s`; }
        async function fetchTrackedDomains() { try { const response = await fetch('/api/domains'); if (!response.ok) throw new Error('Could not fetch domains'); const { domains } = await response.json(); trackedDomainsList.innerHTML = ''; domainFilter.innerHTML = '<option value="all">All Domains</option>'; if (domains.length > 0) { domains.sort().forEach(domain => { const li = document.createElement('li'); li.className = 'flex justify-between items-center'; li.innerHTML = `<span>${domain}</span><button data-domain="${domain}" class="delete-domain-btn text-red-500 hover:text-red-700 text-lg">&times;</button>`; trackedDomainsList.appendChild(li); const option = document.createElement('option'); option.value = domain; option.textContent = domain; domainFilter.appendChild(option); }); } else { trackedDomainsList.innerHTML = '<li class="text-gray-500">No domains tracked.</li>'; } } catch (error) { trackedDomainsList.innerHTML = `<li class="text-red-500">${error.message}</li>`; } }
        async function deleteDomain(domain) { if (!confirm(`Are you sure you want to delete ${domain}?`)) return; try { const response = await fetch('/api/domains', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ domain }), }); if (!response.ok) { const { message } = await response.json(); throw new Error(message || 'Failed to delete domain.'); } await fetchTrackedDomains(); } catch (error) { alert(`Error: ${error.message}`); } }
        function generateTrackingScript() { const endpoint = `${window.location.origin}/api/bpx`; fullTrackingScript = `<script>\\n(async function() {\\n  try {\\n    await fetch('${endpoint}', {\\n      method: 'POST',\\n      headers: { 'Content-Type': 'application/json' },\\n      body: JSON.stringify({ data: { u: window.location.href, r: document.referrer } }),\\n      mode: 'cors'\\n    });\\n  } catch(e) { /* Analytics script failed silently */ }\\n})();\\n<\\/script>`; trackingScriptBlock.textContent = fullTrackingScript; }
        domainFilter.addEventListener('change', () => { if (apiDataCache) renderDashboardView(apiDataCache); });
        timeRangeSelector.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { timeRangeSelector.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); const period = e.target.dataset.period; fetchDataAndRender(period); } });
        addDomainForm.addEventListener('submit', async (e) => { e.preventDefault(); const domain = domainInput.value.trim(); if (!domain) return; formMessage.textContent = 'Adding...'; try { const response = await fetch('/api/domains', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ domain }), }); const result = await response.json(); if (response.ok) { formMessage.textContent = `SUCCESS: Domain '${domain}' added.`; formMessage.className = 'text-sm text-green-600'; domainInput.value = ''; await fetchTrackedDomains(); } else { throw new Error(result.message || 'Failed to add domain.'); } } catch (error) { formMessage.textContent = `ERROR: ${error.message}`; formMessage.className = 'text-sm text-red-600'; } });
        trackedDomainsList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-domain-btn')) { const domain = e.target.dataset.domain; deleteDomain(domain); } });
        copyScriptButton.addEventListener('click', () => { navigator.clipboard.writeText(fullTrackingScript).then(() => { copyScriptButton.textContent = 'COPIED!'; setTimeout(() => { copyScriptButton.textContent = 'COPY'; }, 2000); }, () => { copyScriptButton.textContent = 'ERROR'; }); });
        function updateFooterTimestamp() { lastUpdatedSpan.textContent = new Date().toLocaleString(); }
        function initializeDashboard() { const initialPeriod = timeRangeSelector.querySelector('.active').dataset.period; fetchDataAndRender(initialPeriod); fetchTrackedDomains(); generateTrackingScript(); updateFooterTimestamp(); setInterval(updateFooterTimestamp, 1000 * 60); }
        window.showLogDetails = showLogDetails; window.showSummaryView = showSummaryView; window.requestAdminView = requestAdminView;
        initializeDashboard();
    </script>
</body>
</html>

