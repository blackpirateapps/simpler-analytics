<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <style>
        body { 
            font-family: monospace; 
            background-color: #0d1117; 
            color: #c9d1d9; 
            padding: 2rem;
            max-width: 1200px;
            margin: auto;
        }
        h1, h2, h3 { 
            color: #58a6ff; 
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        pre, code { 
            background-color: #161b22; 
            padding: 1rem; 
            border: 1px solid #30363d;
            border-radius: 6px; 
            white-space: pre-wrap;
            word-break: break-all;
            display: block;
        }
        a { color: #58a6ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #30363d; }
        th { color: #8b949e; }
        input[type="text"] {
            background-color: #161b22;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 0.5rem;
            border-radius: 6px;
        }
        button {
            background-color: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background-color: #30363d; }
        details > summary { cursor: pointer; padding: 0.5rem 0; }
    </style>
</head>
<body>

    <h1>Analytics Dashboard</h1>

    <section>
        <h2>Manage Domains</h2>
        <form id="add-domain-form">
            <input type="text" id="domain-input" placeholder="example.com" required>
            <button type="submit">Add Domain</button>
        </form>
        <div id="form-message" style="min-height: 1.25rem; margin-top: 0.5rem;"></div>
        <h3>Tracked Domains</h3>
        <ul id="tracked-domains-list" style="list-style: none; padding-left: 0;"><li>Loading...</li></ul>
    </section>
    
    <section>
        <h2>Tracking Script</h2>
        <p>// Add this to the &lt;body&gt; of sites you want to track.</p>
        <pre><code id="tracking-script-block">Generating script...</code></pre>
        <button id="copy-script-button" style="margin-top: 1rem;">Copy Script</button>
    </section>

    <section>
        <h2>Domain Summaries (Unique Visitors)</h2>
        <div id="domain-summary-content"><p>Loading summaries...</p></div>
    </section>

    <section>
        <h2>Page Details</h2>
        <div id="analytics-container"><p>Loading page details...</p></div>
    </section>

    <script>
        // --- DOM Refs ---
        const analyticsContainer = document.getElementById('analytics-container');
        const addDomainForm = document.getElementById('add-domain-form');
        const domainInput = document.getElementById('domain-input');
        const formMessage = document.getElementById('form-message');
        const trackedDomainsList = document.getElementById('tracked-domains-list');
        const trackingScriptBlock = document.getElementById('tracking-script-block');
        const copyScriptButton = document.getElementById('copy-script-button');
        const domainSummaryContent = document.getElementById('domain-summary-content');

        let fullTrackingScript = '';

        // --- SCRIPT SNIPPET & COPY ---
        function generateTrackingScript() {
            const endpoint = `${window.location.origin}/api/bpx`;
            const scriptContent = `<script>
(async function() {
  try {
    const endpoint = '${endpoint}';
    const payload = { data: { u: window.location.href, r: document.referrer } };
    await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      mode: 'cors'
    });
  } catch(e) { /* Analytics script failed silently */ }
})();
<\/script>`;
            
            fullTrackingScript = scriptContent;
            trackingScriptBlock.textContent = scriptContent;
        }

        copyScriptButton.addEventListener('click', () => {
            if (!fullTrackingScript) return;
            navigator.clipboard.writeText(fullTrackingScript).then(() => {
                copyScriptButton.textContent = 'Copied!';
                setTimeout(() => { copyScriptButton.textContent = 'Copy Script'; }, 2000);
            }).catch(err => {
                console.error('Failed to copy script: ', err);
                copyScriptButton.textContent = 'Error';
            });
        });

        // --- DOMAIN MANAGEMENT ---
        async function fetchTrackedDomains() {
            try {
                const response = await fetch('/api/domains');
                const { domains } = await response.json();
                trackedDomainsList.innerHTML = '';
                if (domains.length > 0) {
                    domains.sort();
                    domains.forEach(domain => {
                        const li = document.createElement('li');
                        li.innerHTML = `- <a href="details.html?domain=${domain}" target="_blank">${domain}</a>`;
                        trackedDomainsList.appendChild(li);
                    });
                } else {
                    trackedDomainsList.innerHTML = '<li>No domains tracked.</li>';
                }
            } catch (error) {
                console.error('Error fetching domains:', error);
                trackedDomainsList.innerHTML = '<li>Error loading domains.</li>';
            }
        }

        addDomainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const domain = domainInput.value.trim();
            if (!domain) return;
            formMessage.textContent = 'Adding...';
            try {
                const response = await fetch('/api/domains', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain }),
                });
                if (response.ok) {
                    formMessage.textContent = `Success: Domain '${domain}' added.`;
                    domainInput.value = '';
                    await fetchTrackedDomains();
                    await fetchDomainSummaries();
                } else {
                    const { message } = await response.json();
                    throw new Error(message || 'Failed to add domain.');
                }
            } catch (error) {
                console.error('Error adding domain:', error);
                formMessage.textContent = `Error: ${error.message}`;
            }
        });
        
        // --- DATA FETCHING & RENDERING ---
        async function fetchDomainSummaries() {
            try {
                const response = await fetch('/api/bpx?view=domain_summary');
                const data = await response.json();
                const domains = Object.keys(data).sort();

                if (domains.length === 0) {
                    domainSummaryContent.innerHTML = '<p>No summary data available.</p>';
                    return;
                }

                let tableHtml = `<table>
                    <thead><tr><th>Domain</th><th>Today</th><th>This Week</th><th>This Month</th><th>This Year</th></tr></thead>
                    <tbody>`;
                
                domains.forEach(domain => {
                    const stats = data[domain];
                    tableHtml += `<tr>
                        <td><a href="details.html?domain=${domain}" target="_blank">${domain}</a></td>
                        <td>${stats.daily.toLocaleString()}</td>
                        <td>${stats.weekly.toLocaleString()}</td>
                        <td>${stats.monthly.toLocaleString()}</td>
                        <td>${stats.yearly.toLocaleString()}</td>
                    </tr>`;
                });

                tableHtml += `</tbody></table>`;
                domainSummaryContent.innerHTML = tableHtml;
            } catch(error) {
                console.error('Error fetching domain summaries:', error);
                domainSummaryContent.innerHTML = '<p>Failed to load domain summaries.</p>';
            }
        }

        async function fetchPageDetails() {
            try {
                const response = await fetch('/api/bpx');
                const data = await response.json();
                analyticsContainer.innerHTML = '';
                const domains = Object.keys(data).sort();
                if (domains.length === 0) {
                    analyticsContainer.innerHTML = '<p>No page data received yet.</p>';
                    return;
                }
                
                for (const domain of domains) {
                    const pages = data[domain].sort((a, b) => b.views - a.views);
                    const domainDetails = document.createElement('details');
                    domainDetails.open = true;
                    
                    let pagesHtml = pages.map(page => {
                        const path = new URL(page.url).pathname;
                        return `<tr>
                            <td title="${page.url}">${path}</td>
                            <td>${(page.unique_views || 0).toLocaleString()}</td>
                            <td>${page.views.toLocaleString()}</td>
                        </tr>`;
                    }).join('');
                    
                    domainDetails.innerHTML = `<summary><h3><a href="details.html?domain=${domain}" target="_blank">${domain}</a></h3></summary>
                        <table>
                            <thead><tr><th>Path</th><th>Uniques</th><th>Views</th></tr></thead>
                            <tbody>${pagesHtml}</tbody>
                        </table>`;
                    analyticsContainer.appendChild(domainDetails);
                }
            } catch (error) {
                console.error('Error fetching page details:', error);
                analyticsContainer.innerHTML = '<p>Failed to load page details.</p>';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            generateTrackingScript();
            fetchTrackedDomains();
            fetchDomainSummaries();
            fetchPageDetails();
        });
    </script>
</body>
</html>

