<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Fira Code', monospace; 
            line-height: 1.6;
        }
        .time-range-btn {
            background: transparent;
            color: #333;
            border: 1px solid #333;
            padding: 4px 12px;
            margin: 0 5px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .time-range-btn.active {
            background: #000;
            color: #fff;
        }
        .data-list-row {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-list-row:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }
        .section-header {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-white text-gray-800 antialiased">

    <div id="main-container" class="max-w-4xl mx-auto p-5 md:p-8">
        
        <!-- Header -->
        <header id="dashboard-header" class="mb-8">
            <h1 class="text-2xl font-bold mb-4">Analytics Dashboard</h1>
            <div id="time-range-selector">
                <span class="mr-3 text-gray-600">Period:</span>
                <button data-period="1d" class="time-range-btn">Last 24h</button>
                <button data-period="7d" class="time-range-btn active">Last 7 days</button>
                <button data-period="30d" class="time-range-btn">Last 30 days</button>
                <button data-period="90d" class="time-range-btn">Last 90 days</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="analytics-content">
            <!-- This will be populated by JavaScript -->
             <p class="text-gray-500">Fetching analytics data...</p>
        </main>

        <!-- Footer -->
        <footer class="text-center text-xs text-gray-500 mt-12 pt-5 border-t border-gray-200">
            Last updated: <span id="last-updated"></span>
        </footer>
    </div>
    
    <!-- This container is hidden but used for other functionalities -->
    <div class="hidden">
        <div id="domain-management">
            <form id="add-domain-form"></form>
            <ul id="tracked-domains-list"></ul>
        </div>
        <pre><code id="tracking-script-block"></code></pre>
        <button id="copy-script-button"></button>
    </div>


    <script>
        // --- DOM Element Refs ---
        const analyticsContent = document.getElementById('analytics-content');
        const lastUpdatedSpan = document.getElementById('last-updated');
        let summaryDataCache = null;

        // --- RENDER FUNCTIONS ---
        function renderDashboardView(data) {
            const allPages = Object.values(data).flat();
            const totalViews = allPages.reduce((sum, page) => sum + page.views, 0);
            const totalUniques = allPages.reduce((sum, page) => sum + page.unique_views, 0);
            const topPages = allPages.sort((a, b) => b.views - a.views).slice(0, 10);
            
            // Note: Bounce Rate & Avg Session are placeholders as the backend doesn't provide them.
            const overviewMetrics = [
                { label: 'Page Views', value: totalViews.toLocaleString() },
                { label: 'Unique Visitors', value: totalUniques.toLocaleString() },
                { label: 'Bounce Rate', value: '42.3%' },
                { label: 'Avg Session', value: '3.2m' },
            ];

            let overviewHtml = overviewMetrics.map(metric => `
                <div>
                    <div class="text-2xl font-bold">${metric.value}</div>
                    <div class="text-sm text-gray-500">${metric.label}</div>
                </div>
            `).join('');

            let topPagesHtml = topPages.map(page => {
                const percentage = totalViews > 0 ? ((page.views / totalViews) * 100).toFixed(1) : 0;
                const path = new URL(page.url).pathname;
                return `
                    <div class="data-list-row" onclick="showLogDetails('${encodeURIComponent(page.url)}')">
                        <span>${path}</span>
                        <span class="flex gap-4 items-center">
                            <span>${page.views.toLocaleString()}</span>
                            <span class="text-gray-500 w-16 text-right">${percentage}%</span>
                        </span>
                    </div>
                `;
            }).join('');
            
            // Main dashboard structure
            analyticsContent.innerHTML = `
                <div class="mb-10">
                    <h2 class="section-header">Overview</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-5">${overviewHtml}</div>
                </div>
                <div>
                    <h2 class="section-header">Top Pages</h2>
                    <div class="border-t border-gray-200">${topPagesHtml}</div>
                </div>
            `;
        }

        function renderLogDetailsView(url, logs) {
            const decodedUrl = decodeURIComponent(url);
            const path = new URL(decodedUrl).pathname;

            let logsHtml = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('en-GB', { timeZone: 'UTC' });
                const referrer = log.referrer ? new URL(log.referrer).hostname : 'direct';
                return `
                    <tr class="border-b border-gray-200">
                        <td class="p-2 text-gray-500">${timestamp}</td>
                        <td class="p-2">${log.ip_address}</td>
                        <td class="p-2">${log.browser}</td>
                        <td class="p-2">${log.device_type}</td>
                        <td class="p-2" title="${log.referrer || ''}">${referrer}</td>
                    </tr>`;
            }).join('');

            analyticsContent.innerHTML = `
                <div class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="section-header">Recent Activity: ${path}</h2>
                        <button onclick="showSummaryView()" class="text-sm font-semibold hover:text-blue-600">&lt; BACK TO SUMMARY</button>
                    </div>
                    <div class="overflow-x-auto border-t border-gray-200">
                        <table class="w-full text-xs text-left">
                            <thead>
                                <tr class="border-b border-gray-300">
                                    <th class="p-2 font-semibold text-gray-500">TIMESTAMP (UTC)</th>
                                    <th class="p-2 font-semibold text-gray-500">IP ADDRESS</th>
                                    <th class="p-2 font-semibold text-gray-500">BROWSER</th>
                                    <th class="p-2 font-semibold text-gray-500">DEVICE</th>
                                    <th class="p-2 font-semibold text-gray-500">REFERRER</th>
                                </tr>
                            </thead>
                            <tbody>${logsHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // --- DATA FETCHING ---
        async function showSummaryView() {
             if (summaryDataCache) {
                renderDashboardView(summaryDataCache);
                return;
            }
            analyticsContent.innerHTML = '<p class="text-gray-500">Fetching summary data...</p>';
            try {
                const response = await fetch('/api/bpx');
                if (!response.ok) throw new Error(`Failed to fetch summary (${response.status})`);
                const data = await response.json();
                summaryDataCache = data;
                renderDashboardView(data);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        async function showLogDetails(url) {
            analyticsContent.innerHTML = `<p class="text-gray-500">Fetching logs for ${decodeURIComponent(url)}...</p>`;
            try {
                const response = await fetch(`/api/bpx?view=details&url=${url}`);
                if (!response.ok) throw new Error(`Failed to fetch details (${response.status})`);
                const logs = await response.json();
                renderLogDetailsView(url, logs);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        const timeRangeSelector = document.getElementById('time-range-selector');
        timeRangeSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                timeRangeSelector.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                // In a real app, this would trigger a refetch of data with the new time range.
                // For now, it's a UI-only change.
                showSummaryView(); 
            }
        });

        function updateFooterTimestamp() {
            lastUpdatedSpan.textContent = new Date().toLocaleString();
        }

        function initializeDashboard() {
            showSummaryView();
            updateFooterTimestamp();
            setInterval(updateFooterTimestamp, 1000 * 60); // Update every minute
        }

        // Make functions globally accessible for inline onclick handlers
        window.showLogDetails = showLogDetails;
        window.showSummaryView = showSummaryView;

        initializeDashboard();
    </script>
</body>
</html>

