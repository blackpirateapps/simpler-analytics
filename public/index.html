<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Fira Code', monospace; 
            line-height: 1.6;
            background-color: #f0f0f0;
        }
        .brutalist-card {
            background-color: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0px black;
        }
        .time-range-btn {
            background: transparent;
            color: #000;
            border: 2px solid #000;
            padding: 4px 12px;
            margin: 0 5px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.1s ease-in-out;
        }
        .time-range-btn.active, .time-range-btn:hover {
            background: #000;
            color: #fff;
        }
        .data-list-row {
            border-bottom: 2px solid #000;
            padding: 10px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-list-row:hover {
            background-color: #ffff00;
            cursor: pointer;
        }
        .section-header {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(90deg); }
        .arrow { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="text-black antialiased">

    <div id="main-container" class="max-w-4xl mx-auto p-5 md:p-8">
        <h1 class="text-3xl font-bold mb-6 text-center md:text-left">Web Analytics Overview</h1>
        
        <details class="mb-8 brutalist-card">
            <summary class="font-semibold cursor-pointer text-lg p-4 flex justify-between items-center">
                <span>Settings & Tracking Script</span>
                <svg class="w-5 h-5 arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </summary>
            <div class="p-4 mt-2 grid grid-cols-1 md:grid-cols-2 gap-8 pt-4 border-t-2 border-black">
                <div>
                    <h3 class="font-semibold mb-3">Manage Tracked Domains</h3>
                    <form id="add-domain-form" class="flex items-center space-x-2 mb-4">
                        <input type="text" id="domain-input" placeholder="example.com" class="border-2 border-black px-2 py-1 flex-grow w-full" required>
                        <button type="submit" class="bg-black text-white px-4 py-1 border-2 border-black hover:bg-gray-800">ADD</button>
                    </form>
                    <div id="form-message" class="text-sm min-h-[1.25rem] font-mono"></div>
                    <h4 class="mt-4 mb-2 text-sm font-semibold">Tracked Domains:</h4>
                    <ul id="tracked-domains-list" class="space-y-1 text-sm"><li>Loading...</li></ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-3">Get Tracking Script</h3>
                    <p class="text-sm mb-4">Add this script inside the &lt;body&gt; tag of any site you want to track.</p>
                    <div class="relative">
                        <pre><code id="tracking-script-block" class="bg-black text-white text-xs p-4 block whitespace-pre-wrap border-2 border-black"></code></pre>
                        <button id="copy-script-button" class="absolute top-2 right-2 bg-white text-black border-2 border-black text-xs font-semibold px-2 py-1 hover:bg-yellow-300">COPY</button>
                    </div>
                </div>
            </div>
        </details>

        <header id="dashboard-header" class="mb-8 p-4 brutalist-card">
            <div class="flex flex-wrap items-center gap-y-4 gap-x-8">
                <div id="time-range-selector">
                    <span class="mr-3">Period:</span>
                    <button data-period="all_time" class="time-range-btn active">All Time</button>
                    <button data-period="1d" class="time-range-btn">Last 24h</button>
                    <button data-period="7d" class="time-range-btn">Last 7 days</button>
                    <button data-period="30d" class="time-range-btn">Last 30 days</button>
                </div>
                 <div id="domain-filter-container">
                    <span class="mr-3">Domain:</span>
                    <select id="domain-filter" class="border-2 border-black p-1.5 text-sm bg-white">
                        <option value="all">All Domains</option>
                    </select>
                </div>
            </div>
        </header>

        <main id="analytics-content" class="brutalist-card p-4">
            <p>Fetching analytics data...</p>
        </main>
        
        <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
            <div class="p-6 brutalist-card w-full max-w-sm">
                <h3 class="text-lg font-semibold mb-4">Admin Access Required</h3>
                <p id="password-prompt-message" class="text-sm mb-4"></p>
                <input type="password" id="admin-password-input" class="border-2 border-black w-full px-3 py-2 mb-4" placeholder="Enter Admin Password">
                <div class="flex justify-end gap-3">
                    <button id="password-cancel-btn" class="px-4 py-2 border-2 border-black hover:bg-gray-200">Cancel</button>
                    <button id="password-submit-btn" class="px-4 py-2 bg-black text-white border-2 border-black hover:bg-gray-800">Submit</button>
                </div>
            </div>
        </div>

        <footer class="text-center text-xs mt-12 pt-5 border-t-2 border-black">
            Last updated: <span id="last-updated"></span>
        </footer>
    </div>

    <script>
        // --- DOM Element Refs & State ---
        const analyticsContent = document.getElementById('analytics-content');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const addDomainForm = document.getElementById('add-domain-form');
        const domainInput = document.getElementById('domain-input');
        const formMessage = document.getElementById('form-message');
        const trackedDomainsList = document.getElementById('tracked-domains-list');
        const trackingScriptBlock = document.getElementById('tracking-script-block');
        const copyScriptButton = document.getElementById('copy-script-button');
        const domainFilter = document.getElementById('domain-filter');
        const timeRangeSelector = document.getElementById('time-range-selector');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('admin-password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordCancelBtn = document.getElementById('password-cancel-btn');
        const passwordPromptMessage = document.getElementById('password-prompt-message');
        
        let fullTrackingScript = '';
        let passwordResolve = null;

        // --- UTILS ---
        const formatSeconds = (seconds) => {
            const s = Math.round(seconds || 0);
            if (s < 60) return `${s}s`;
            return `${Math.floor(s / 60)}m ${s % 60}s`;
        };

        // --- PASSWORD MODAL ---
        const getAdminPassword = (message) => {
            passwordPromptMessage.textContent = message;
            passwordModal.classList.remove('hidden');
            passwordModal.classList.add('flex');
            passwordInput.focus();
            return new Promise(resolve => { passwordResolve = resolve; });
        };
        passwordSubmitBtn.addEventListener('click', () => {
            if (passwordResolve) passwordResolve(passwordInput.value);
            passwordModal.classList.add('hidden');
            passwordModal.classList.remove('flex');
            passwordInput.value = '';
        });
        passwordCancelBtn.addEventListener('click', () => {
            if (passwordResolve) passwordResolve(null);
            passwordModal.classList.add('hidden');
            passwordModal.classList.remove('flex');
            passwordInput.value = '';
        });
        
        // --- RENDER FUNCTIONS ---
        function renderDashboardView(data) {
            const { overview, topPages } = data;
            const overviewMetrics = [
                { label: 'Page Views', value: (overview.pageViews || 0).toLocaleString() },
                { label: 'Unique Visitors', value: (overview.uniqueVisitors || 0).toLocaleString() },
                { label: 'Bounce Rate', value: `${overview.bounceRate}%` },
                { label: 'Avg. Active Time', value: formatSeconds(overview.avgSiteActiveTimeSeconds) },
            ];

            const overviewHtml = overviewMetrics.map(m => `<div><div class="text-2xl font-bold">${m.value}</div><div class="text-sm">${m.label}</div></div>`).join('');
            
            const topPagesHtml = topPages.length > 0 ? topPages.map(page => {
                const totalViews = overview.pageViews || 0;
                const percentage = totalViews > 0 ? ((page.views / totalViews) * 100).toFixed(1) : 0;
                const path = new URL(page.url).pathname;
                return `<div class="data-list-row" onclick="showLogDetails('${encodeURIComponent(page.url)}')">
                    <span>${path}</span>
                    <span class="flex gap-4 items-center text-sm">
                        <span>${(page.unique_views || 0).toLocaleString()} <span class="text-gray-500">uniques</span></span>
                        <span>${(page.views || 0).toLocaleString()} <span class="text-gray-500">views</span></span>
                        <span class="text-gray-500 w-16 text-right">${percentage}%</span>
                    </span>
                </div>`;
            }).join('') : '<p class="p-4 text-center">No page view data found for this period.</p>';

            analyticsContent.innerHTML = `<div class="mb-10"><h2 class="section-header">Overview</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-5">${overviewHtml}</div></div><div><h2 class="section-header">Top Pages</h2><div class="border-t-2 border-black">${topPagesHtml}</div></div>`;
        }

        function renderLogDetailsView(url, logs, isAdmin = false) {
            const path = new URL(decodeURIComponent(url)).pathname;
            const ipHeader = isAdmin ? '<th class="p-2 font-semibold">IP ADDRESS</th>' : '';
            const logsHtml = logs.map(log => {
                const ipCell = isAdmin ? `<td class="p-2">${log.ip_address}</td>` : '';
                return `<tr class="border-b-2 border-black text-xs"><td class="p-2 text-gray-500">${new Date(log.timestamp).toLocaleString('en-GB',{timeZone:'UTC'})}</td><td class="p-2">${log.country}</td>${ipCell}<td class="p-2">${log.browser}</td><td class="p-2">${log.device_type}</td><td class="p-2" title="${log.referrer||''}">${log.referrer?new URL(log.referrer).hostname:'direct'}</td></tr>`;
            }).join('');
            const showIpBtn = !isAdmin ? `<button onclick="showIpAddress('${url}')" class="text-xs font-semibold hover:text-blue-600">Show IP</button>` : '';

            analyticsContent.innerHTML = `<div class="mb-10"><div class="flex justify-between items-center mb-4"><h2 class="section-header">Recent Activity: ${path}</h2><div class="flex gap-4 items-center">${showIpBtn}<button onclick="fetchDataAndRender()" class="text-sm font-semibold hover:text-blue-600">&lt; BACK</button></div></div><div class="overflow-x-auto border-t-2 border-black"><table class="w-full text-left"><thead><tr class="border-b-2 border-black text-xs"><th class="p-2 font-semibold">TIMESTAMP (UTC)</th><th class="p-2 font-semibold">COUNTRY</th>${ipHeader}<th class="p-2 font-semibold">BROWSER</th><th class="p-2 font-semibold">DEVICE</th><th class="p-2 font-semibold">REFERRER</th></tr></thead><tbody>${logsHtml}</tbody></table></div></div>`;
        }
        
        // --- DATA FETCHING ---
        async function fetchDataAndRender() {
            const period = timeRangeSelector.querySelector('.active').dataset.period;
            const domain = domainFilter.value;
            analyticsContent.innerHTML = '<p>Fetching analytics data...</p>';
            try {
                const response = await fetch(`/api/bpx?period=${period}&domain=${domain}`);
                if (!response.ok) throw new Error(`Failed to fetch data (${response.status})`);
                const data = await response.json();
                renderDashboardView(data);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        async function showLogDetails(url, admin_key = null) {
            analyticsContent.innerHTML = `<p>Fetching logs...</p>`;
            try {
                const apiUrl = `/api/bpx?view=details&url=${url}${admin_key ? `&admin_key=${admin_key}`:''}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Failed to fetch logs (${response.status})`);
                const logs = await response.json();
                renderLogDetailsView(url, logs, !!admin_key);
            } catch (error) {
                analyticsContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        async function showIpAddress(url) {
            const password = await getAdminPassword('To view IP addresses, please enter the admin password.');
            if (password) {
                showLogDetails(url, password);
            }
        }

        // --- DOMAIN MANAGEMENT ---
        async function fetchTrackedDomains() {
            try {
                const response = await fetch('/api/domains'); 
                const { domains } = await response.json();
                trackedDomainsList.innerHTML = '';
                domainFilter.innerHTML = '<option value="all">All Domains</option>';
                if (domains.length > 0) {
                    domains.sort().forEach(d => {
                        trackedDomainsList.innerHTML += `<li class="flex justify-between items-center"><span>${d}</span><button data-domain="${d}" class="delete-domain-btn text-red-500 hover:text-red-700 text-lg">&times;</button></li>`;
                        domainFilter.innerHTML += `<option value="${d}">${d}</option>`;
                    });
                } else {
                    trackedDomainsList.innerHTML = '<li class="text-gray-500">No domains tracked.</li>';
                }
            } catch (error) {
                trackedDomainsList.innerHTML = `<li class="text-red-500">${error.message}</li>`;
            }
        }
        
        async function deleteDomain(domain) {
            const password = await getAdminPassword(`To delete '${domain}', please enter the admin password.`);
            if (!password) return;
            try {
                const response = await fetch('/api/domains', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, admin_key: password }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to delete domain.');
                await fetchTrackedDomains();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function generateTrackingScript() {
            const endpoint = `${window.location.origin}/api/pizzle.js`;
            fullTrackingScript = `<script src="${endpoint}"><\/script>`;
            trackingScriptBlock.textContent = fullTrackingScript;
        }

        // --- EVENT LISTENERS & INIT ---
        domainFilter.addEventListener('change', fetchDataAndRender);
        timeRangeSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                timeRangeSelector.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                fetchDataAndRender();
            }
        });
        addDomainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const domain = domainInput.value.trim();
            if (!domain) return;
            formMessage.textContent = 'Adding...';
            try {
                const response = await fetch('/api/domains', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({domain}) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                formMessage.textContent = `SUCCESS: Domain '${domain}' added.`;
                formMessage.className = 'text-sm text-green-600';
                domainInput.value = '';
                await fetchTrackedDomains();
            } catch (error) {
                formMessage.textContent = `ERROR: ${error.message}`;
                formMessage.className = 'text-sm text-red-600';
            }
        });
        trackedDomainsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-domain-btn')) deleteDomain(e.target.dataset.domain);
        });
        copyScriptButton.addEventListener('click', () => navigator.clipboard.writeText(fullTrackingScript).then(() => { copyScriptButton.textContent = 'COPIED!'; setTimeout(() => { copyScriptButton.textContent = 'COPY'; }, 2000); }, () => { copyScriptButton.textContent = 'ERROR'; }));
        
        const updateFooterTimestamp = () => lastUpdatedSpan.textContent = new Date().toLocaleString();

        function initializeDashboard() {
            fetchDataAndRender();
            fetchTrackedDomains();
            generateTrackingScript();
            updateFooterTimestamp();
            setInterval(updateFooterTimestamp, 60000);
        }

        window.showLogDetails = showLogDetails;
        window.showIpAddress = showIpAddress;
        window.fetchDataAndRender = fetchDataAndRender;
        initializeDashboard();
    </script>
</body>
</html>

